name: Build ST Terminal

on:
  push:
    paths:
      - 'st/**'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential curl git wget make \
          libx11-dev libxft-dev libxext-dev pkg-config \
          patchelf zip

    - name: Download and extract ST source
      run: |
        mkdir -p ~/st-build
        cd ~/st-build
        wget https://dl.suckless.org/st/st-0.9.tar.gz
        tar -xzf st-0.9.tar.gz

    - name: Write custom config.h
      run: |
        cat > ~/st-build/st-0.9/config.h << 'EOF'
        static char *font = "monospace:pixelsize=14:antialias=true:autohint=true";
        static int borderpx = 2;
        static char *shell = "/bin/sh";

        static float cwscale = 1.0;
        static float chscale = 1.0;

        static unsigned int cursorshape = 2; // block
        static int cursorblink = 0;

        static char *colorname[] = {
          "black",   // 0
          "red",     // 1
          "green",   // 2
          "yellow",  // 3
          "blue",    // 4
          "magenta", // 5
          "cyan",    // 6
          "white",   // 7
          [256] = "#00ffff", // foreground (cyan)
          [257] = "#000000", // background (black)
          [258] = "#00ff00", // cursor (green)
        };

        unsigned int defaultfg = 256;
        unsigned int defaultbg = 257;
        unsigned int defaultcs = 258;
        unsigned int defaultrcs = 258;

        unsigned int tabspaces = 8;
        wchar_t *worddelimiters = L" ";
        EOF

    - name: Patch x.c to force green cursor
      run: |
        sed -i '/^.*if *(selected(x, y)) *{/,/^.*} *else *{/c\
        \tg.bg = defaultbg;\n\tg.fg = defaultcs;' ~/st-build/st-0.9/x.c

    - name: Build ST
      run: |
        cd ~/st-build/st-0.9
        make

    - name: Upload binary
      uses: actions/upload-artifact@v4
      with:
        name: st-binary
        path: ~/st-build/st-0.9/st
